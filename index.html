<!doctype html>
<html lang="en" dir="ltr">
<head>

<link rel="icon" type="image/png" href="tab.png">
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stork Runner</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

        body {
            margin: 0; padding: 0; background-color: #050505; color: white;
            font-family: 'Orbitron', sans-serif; overflow: hidden;
            width: 100vw; height: 100vh; display: flex;
            justify-content: center; align-items: center; touch-action: none;
        }

        #game-container {
            position: relative; width: 100%; height: 100%;
            background: linear-gradient(180deg, #111827 0%, #1f2937 100%);
            overflow: hidden; box-shadow: 0 0 20px rgba(0, 255, 157, 0.1);
        }

        @media (min-width: 800px) {
            #game-container { 
                max-width: 1200px;      
                max-height: 800px;      
                border: 2px solid #00ff9d50; 
                border-radius: 15px;  
            }
            #gameLogo { top: 10% !important; width: 40% !important; }
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* UI Elements */
        .ui-layer {
            position: absolute; top: 10px; left: 0; width: 100%; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: none; box-sizing: border-box; z-index: 10;
        }
        .speed-meter { font-size: 14px; color: #00b8ff; margin-top: 5px; }
        #right-container { display: flex; flex-direction: column; align-items: flex-end; }
        #scoreDisplay { font-size: 20px; color: #00ff9d; text-shadow: 0 0 3px #00ff9d50; display: flex; align-items: baseline; gap: 5px; }
        .life-display { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 25px; }
        .magnet-timer { font-size: 14px; color: #ffcc00; opacity: 0; transition: opacity 0.3s; margin-top: 5px;}
        .magnet-timer.active { opacity: 1; }

        /* Overlays */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 20; backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }

        h1 { color: #00ff9d; text-transform: uppercase; margin: 10px 0; text-align: center; font-size: 28px; }
        p { color: #ccc; font-size: 14px; margin-bottom: 15px; text-align: center; }

        /* Buttons & Inputs */
        input[type="text"] {
            padding: 10px; border-radius: 5px; border: 1px solid #00ff9d;
            background: #1f2937; color: white; font-family: 'Orbitron'; 
            margin: 0 auto 15px auto;
            text-align: center;
            width: 80%; 
            display: block; 
        }
        button {
            background: #00ff9d; color: black; border: none; padding: 12px 30px;
            font-size: 16px; font-weight: bold; font-family: 'Orbitron', sans-serif;
            cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: transform 0.1s; margin: 5px;
            flex-shrink: 0; 
        }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        .secondary-btn { background: #00b8ff; color: white; }

        /* --- LOBBY LAYOUT --- */
        .lobby-panel { 
            background: rgba(255,255,255,0.05); 
            padding: 20px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 450px; 
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center; 
            max-height: 85%;
        }

        .player-list { 
            list-style: none; 
            padding: 0; 
            margin: 10px 0; 
            text-align: left; 
            width: 100%;
            max-height: 300px; 
            overflow-y: auto;  
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 157, 0.2); 
            border-radius: 5px;
        }

        .player-list::-webkit-scrollbar { width: 5px; }
        .player-list::-webkit-scrollbar-thumb { background: #00ff9d; border-radius: 3px; }

        .player-list li { 
            background: rgba(0, 255, 157, 0.05); 
            padding: 12px; 
            margin-bottom: 2px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .is-host { color: #ffd700; font-size: 0.8em; border: 1px solid #ffd700; padding: 2px 5px; border-radius: 4px; }
        
        .lobby-footer {
            margin-top: 10px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        .copy-box { 
            background: #1e293b; padding: 10px; border-radius: 6px; 
            font-family: monospace; font-size: 12px; cursor: pointer; 
            word-break: break-all; margin-bottom: 10px; width: 100%; 
            border: 1px dashed #555; color: #00ff9d;
            flex-shrink: 0;
            box-sizing: border-box; 
        }

        /* --- FINAL LEADERBOARD (Game Over) --- */
        .final-results-container {
            width: 95%;
            max-width: 450px;
            max-height: 50vh; 
            overflow-y: auto;
            background: rgba(0,0,0,0.7);
            border: 1px solid #00ff9d50;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: #00ff9d #222;
        }
        
        .final-results-container::-webkit-scrollbar { width: 6px; }
        .final-results-container::-webkit-scrollbar-track { background: #222; }
        .final-results-container::-webkit-scrollbar-thumb { background-color: #00ff9d; border-radius: 10px; }

        .result-row { 
            display: grid; 
            grid-template-columns: 0.8fr 2.5fr 1fr; /* Rank | Name | Score */
            align-items: center;
            border-bottom: 1px solid #333; 
            padding: 10px 5px; 
            font-size: 14px;
            text-align: left;
        }
        .result-row.header { color: #888; font-size: 11px; border-bottom: 1px solid #00ff9d; margin-bottom: 5px; }
        .status-playing { color: #00ff9d; font-size: 10px; margin-left: 5px; }
        .status-dead { color: #ff4d4d; font-size: 10px; margin-left: 5px; }
        .score-val { color: #fff; text-align: right; font-weight: bold; }

        #gameLogo { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); width: 60%; opacity: 0.2; pointer-events: none; }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="ui-layer">
            <div class="speed-meter">SPEED: <span id="speedVal">1x</span></div> 
            <div id="lifeDisplay" class="life-display"></div>

            <div id="right-container">
                <div id="scoreDisplay">
                    <span id="scoreText">SCORE: </span><span id="scoreVal">0</span>
                </div>
                <div id="magnetTimerDisplay" class="magnet-timer">
                    üß≤ <span id="magnetTimeRemaining">10</span>s
                </div>
            </div>
        </div>

        <img id="gameLogo" src="logo.png" alt="Game Logo"> 
        
        <div id="startScreen" class="overlay">
            <img src="start_logo.png" style="width:150px; margin-bottom:10px;" onerror="this.style.display='none'">
            <h1>Stork Runner</h1>
            
            <div id="loginPanel" class="lobby-panel">
                <button onclick="startSoloGame()" style="width:100%; margin-bottom:15px; background:#f39c12; color:#000;">START SOLO GAME</button>
                
                <p style="margin: 5px 0; font-size:12px;">--- MULTIPLAYER ---</p>
                <input type="text" id="playerNameInput" placeholder="Enter Your Discord Username" maxlength="25">
                <button onclick="showLobbyOption('create')">Create Room</button>
                <button onclick="showLobbyOption('join')" class="secondary-btn">Join Room</button>
            </div>

            <div id="lobbyPanel" class="lobby-panel hidden">
                <h3 id="lobbyTitle" style="flex-shrink: 0; margin: 10px 0;">Lobby</h3>
                
                <div id="linkContainer" style="width: 100%; flex-shrink: 0;">
                    <p style="font-size:12px; color:#aaa; margin: 5px 0;">Tap below to copy link:</p>
                    <div class="copy-box" id="shareLinkBox">Generating Link...</div>
                </div>
                
                <ul class="player-list" id="lobbyPlayerList"></ul>
                
                <div class="lobby-footer">
                    <div id="hostControls" class="hidden" style="width:100%; text-align:center;">
                        <button onclick="startMultiplayerGame()" style="margin-bottom: 5px;">START MATCH</button>
                    </div>
                    <div id="clientStatus" class="hidden">
                        <p style="color:#00ff9d; animation: pulse 1s infinite; margin: 5px 0;">Waiting for host...</p>
                    </div>
                    <button onclick="leaveLobby()" style="background:#ff4d4d; font-size:12px; padding:8px; width: 100px;">Leave</button>
                </div>
            </div>
        </div>

        <div id="gameOverScreen" class="overlay hidden">
            <h1 id="goTitle" style="color:#ff4d4d; margin-bottom: 5px;">GAME OVER</h1>
            
            <div id="multiplayerFinalBoard" class="hidden" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                <p style="font-size:12px; margin-bottom: 5px;">FULL LEADERBOARD</p>
                <div class="final-results-container" id="finalLeaderboard"></div>
            </div>

            <div id="soloFinalScore" class="hidden" style="text-align:center; padding:10px; margin-bottom:10px;"></div>
            
            <div id="goButtons" style="display:flex; flex-direction:column; align-items:center; margin-top: 10px;"></div>
        </div>

        <canvas id="gameCanvas"></canvas>
        <div class="controls-hint" style="position:absolute; bottom:10px; width:100%; text-align:center; opacity:0.5; font-size:10px;">TAP TO JUMP</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect, get, off } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAWa8Pq13oNrX2O0XCL8J6OYqFh5isAbY",
            authDomain: "stork-runner-v1.firebaseapp.com",
            databaseURL: "https://stork-runner-v1-default-rtdb.firebaseio.com",
            projectId: "stork-runner-v1",
            storageBucket: "stork-runner-v1.firebasestorage.app",
            messagingSenderId: "493637635620",
            appId: "1:493637635620:web:ac702514cb7846d9e3d2b1",
            measurementId: "G-BBY37DFGD5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbUpdate = update;
        window.dbRemove = remove;
        window.dbOnValue = onValue;
        window.dbGet = get;
        window.dbOnDisconnect = onDisconnect;
    </script>

    <script>
        // --- Game Variables ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('scoreVal');
        const speedEl = document.getElementById('speedVal');
        const magnetTimerDisplay = document.getElementById('magnetTimerDisplay');
        const magnetTimeRemainingEl = document.getElementById('magnetTimeRemaining');
        const lifeDisplayEl = document.getElementById('lifeDisplay'); 
        
        let loopId = 0;
        let isMultiplayer = false;
        let roomId = null;
        let playerId = null;
        let playerName = "Runner";
        let isHost = false;
        let isGameOver = false;

        // --- Game Physics ---
        const IMAGE_PATH = 'stork.png'; 
        const playerImage = new Image();
        playerImage.src = IMAGE_PATH;
        let playerDisplayWidth = 80;
        let playerDisplayHeight = 80;
        const player = { x: 50, y: 0, width: 80, height: 80, dy: 0, jumpPower: -9, grounded: false, facingRight: true };
        
        let isRunning = false; 
        const gravity = 0.4; 
        let gameSpeed = 5.0; 
        let score = 0;
        let frames = 0;
        let lastTime = 0;
        const targetFPS = 60;
        const targetDelta = 1000 / targetFPS; 

        let isMagnetActive = false;
        let magnetTimer = 0;
        let currentLives = 5; 
        let isInvincible = false;
        let invincibilityTimer = 0;

        let obstacles = [];
        let tokens = [];
        let particles = [];
        
        // Check URL
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('room')){
            document.getElementById('loginPanel').innerHTML = `
                <input type="text" id="playerNameInput" placeholder="Enter Your Discord Username" maxlength="12">
                <button onclick="showLobbyOption('join')" style="width:100%">Join Lobby</button>
            `;
            roomId = urlParams.get('room');
        }

        // --- Sound ---
        const sounds = {
            jump: new Audio('jump.wav'),
            token: new Audio('collect_token.wav'),
            magnet: new Audio('collect_magnet.wav'),
            hit: new Audio('hit.wav'),
            gameOver: new Audio('game_over.wav'),
            click: new Audio('click.wav') 
        };
        function playSound(key) { if(sounds[key]) { sounds[key].currentTime=0; sounds[key].play().catch(()=>{}); } }

        // --- Initialization ---
        playerImage.onload = () => {
            const ar = playerImage.naturalWidth / playerImage.naturalHeight;
            if (ar > 1) { playerDisplayHeight = 80; playerDisplayWidth = 80 * ar; } 
            else { playerDisplayWidth = 80; playerDisplayHeight = 80 / ar; }
            player.width = playerDisplayWidth; player.height = playerDisplayHeight;
        };
        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            if(!isRunning) player.y = canvas.height - 60 - player.height; 
        }
        window.addEventListener('resize', resize); resize();

        // --- Lobby & Network ---
        
        function getPlayerName() {
            let name = document.getElementById('playerNameInput').value.trim();
            if(!name) { alert("Please enter a Username!"); return null; }
            return name;
        }

        window.startSoloGame = function() {
            playSound('click');
            isMultiplayer = false;
            roomId = null;
            initGame();
        }

        window.restartGame = function() {
            playSound('click');
            document.getElementById('gameOverScreen').classList.add('hidden');
            initGame();
        }

        window.showLobbyOption = async function(action) {
            if(!window.db) { alert("Loading Firebase..."); return; }
            const tempName = getPlayerName();
            if(!tempName) return;
            playerName = tempName;
            
            document.getElementById('loginPanel').classList.add('hidden');
            document.getElementById('lobbyPanel').classList.remove('hidden');

            if (action === 'create') {
                playerId = 'host_' + Date.now();
                roomId = 'room_' + Math.floor(Math.random()*10000);
                isHost = true;
                
                document.getElementById('linkContainer').style.display = 'block';

                // ÿ≥ÿßÿÆÿ™ ÿßÿ™ÿßŸÇ ÿ¨ÿØ€åÿØ
                await window.dbSet(window.dbRef(window.db, `rooms/${roomId}`), {
                    status: 'lobby',
                    players: { [playerId]: { name: playerName, score: 0, isHost: true, isDead: false } }
                });
                
                setupLobbyListener();
                setupShareLink();

            } else {
                // JOIN
                if(!roomId) roomId = prompt("Enter Room ID:");
                if(!roomId) { location.reload(); return; }
                
                playerId = 'p_' + Date.now();
                isHost = false;
                document.getElementById('linkContainer').style.display = 'none';

                const roomRef = window.dbRef(window.db, `rooms/${roomId}`);
                const snapshot = await window.dbGet(roomRef);
                
                if(snapshot.exists()) {
                    const roomData = snapshot.val();
                    
                    // --- CHANGED: Case Insensitive Name Check ---
                    if(roomData.players) {
                        const inputName = playerName.trim().toLowerCase();
                        const isTaken = Object.values(roomData.players).some(p => p.name.trim().toLowerCase() === inputName);
                        
                        if(isTaken) {
                            alert("This Username is already taken in this room! Please choose another.");
                            location.reload();
                            return; // ÿ™ŸàŸÇŸÅ ÿßÿ¨ÿ±ÿß
                        }
                    }
                    // ------------------------------------------

                    await window.dbSet(window.dbRef(window.db, `rooms/${roomId}/players/${playerId}`), {
                        name: playerName, score: 0, isHost: false, isDead: false
                    });
                    setupLobbyListener();
                } else {
                    alert("Room not found!");
                    location.href = window.location.pathname;
                }
            }
        }

        function setupShareLink() {
            const fullLink = window.location.origin + window.location.pathname + '?room=' + roomId;
            const box = document.getElementById('shareLinkBox');
            box.innerText = fullLink;
            box.onclick = () => {
                navigator.clipboard.writeText(fullLink).then(() => {
                    const original = box.innerText;
                    box.innerText = "COPIED!";
                    setTimeout(() => box.innerText = original, 1000);
                });
            };
        }

        function setupLobbyListener() {
            isMultiplayer = true;
            const roomRef = window.dbRef(window.db, `rooms/${roomId}`);
            const playerRef = window.dbRef(window.db, `rooms/${roomId}/players/${playerId}`);
            
            // ----------------------------------------

            window.dbOnValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) {
                    if(!isRunning && !isGameOver) { alert("Room closed."); location.href = window.location.pathname; }
                    return;
                }

                // 1. ŸÖÿØ€åÿ±€åÿ™ ŸÑ€åÿ≥ÿ™ ŸÑÿßÿ®€å
                if (document.getElementById('lobbyPanel').classList.contains('hidden') === false) {
                    const list = document.getElementById('lobbyPlayerList');
                    list.innerHTML = ''; 
                    
                    let playerCount = 0;
                    if(data.players) {
                        const players = Object.values(data.players);
                        playerCount = players.length;
                        players.forEach(p => {
                            list.innerHTML += `<li><span>${p.name}</span> ${p.isHost ? '<span class="is-host">HOST</span>' : ''}</li>`;
                        });
                    }
                    
                    document.getElementById('lobbyTitle').innerText = `Lobby (${playerCount} Players)`;

                    if(isHost) document.getElementById('hostControls').classList.remove('hidden');
                    else document.getElementById('clientStatus').classList.remove('hidden');
                }

                // 2. ÿ¥ÿ±Ÿàÿπ ÿ®ÿßÿ≤€å
                if(data.status === 'playing' && !isRunning && !isGameOver) initGame();

                // 3. ŸÖÿØ€åÿ±€åÿ™ ŸÑ€åÿØÿ±ÿ®Ÿàÿ±ÿØ ŸÜŸáÿß€å€å
                if (isGameOver && data.players) {
                    renderFinalLeaderboard(data.players);
                }
            });
        }

        function renderFinalLeaderboard(playersData) {
            const sorted = Object.values(playersData).sort((a,b) => b.score - a.score);
            const lbContainer = document.getElementById('finalLeaderboard');
            
            let html = `
                <div class="result-row header">
                    <span>RANK</span>
                    <span>PLAYER / STATUS</span>
                    <span style="text-align:right">SCORE</span>
                </div>
            `;

            sorted.forEach((p, index) => {
                let medal = index===0 ? 'ü•á' : index===1 ? 'ü•à' : index===2 ? 'ü•â' : `#${index+1}`;
                let statusText = p.isDead ? `<span class="status-dead">(Finished üèÅ)</span>` : `<span class="status-playing">(Playing üèÉ‚Äç‚ôÇÔ∏è)</span>`;
                
                html += `
                    <div class="result-row">
                        <span>${medal}</span>
                        <span>${p.name.substring(0,12)} ${statusText}</span>
                        <span class="score-val">${p.score}</span>
                    </div>
                `;
            });
            
            lbContainer.innerHTML = html;
        }

        window.startMultiplayerGame = function() {
            if(!isHost) return;
            window.dbUpdate(window.dbRef(window.db, `rooms/${roomId}`), { status: 'playing' });
        }

        window.leaveLobby = async function() {
            if (roomId && window.db) {
                try {
                    // Manual clean up is still necessary when clicking the button
                    if (isHost) {
                        await window.dbRemove(window.dbRef(window.db, `rooms/${roomId}`));
                    } else if (playerId) {
                        await window.dbRemove(window.dbRef(window.db, `rooms/${roomId}/players/${playerId}`));
                    }
                } catch (e) { console.log("Error leaving:", e); }
            }
            window.location.href = window.location.pathname; 
        }

        function syncScore() {
            if(!isMultiplayer || !roomId || !playerId) return;
            window.dbUpdate(window.dbRef(window.db, `rooms/${roomId}/players/${playerId}`), { 
                score: Math.floor(score)
            });
        }

        function syncDeath() {
            if(!isMultiplayer || !roomId || !playerId) return;
            window.dbUpdate(window.dbRef(window.db, `rooms/${roomId}/players/${playerId}`), { 
                score: Math.floor(score),
                isDead: true
            });
        }

        // --- Core Game Logic ---

        function initGame() {
            playSound('click');
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            
            isGameOver = false;
            isRunning = true;
            player.y = canvas.height - 60 - player.height;
            player.dy = 0;
            obstacles = []; tokens = []; particles = [];
            score = 0; gameSpeed = 5.0; frames = 0;
            currentLives = 5; 
            isInvincible = false;
            isMagnetActive = false; magnetTimer = 0;
            
            scoreEl.innerText = "0";
            speedEl.innerText = "1x";
            updateLifeDisplay();

            lastTime = 0;
            loopId = requestAnimationFrame(loop); 
        }

        function jump() {
            if (player.grounded && isRunning) {
                player.dy = player.jumpPower;
                player.grounded = false;
                spawnParticles(player.x + player.width / 2, player.y + player.height, '#fff', 5);
                playSound('jump');
            }
        }

        function updateLifeDisplay() {
            lifeDisplayEl.innerHTML = "ü•ö ".repeat(currentLives);
        }

        function spawnParticles(x, y, color, count) {
            for(let i=0; i<count; i++) particles.push({x,y,color, life:1.0, size:Math.random()*3+1, sx:Math.random()*2-1, sy:Math.random()*2-1});
        }

        function gameOver() {
            isRunning = false;
            isGameOver = true;
            cancelAnimationFrame(loopId);
            
            syncDeath();
            playSound('gameOver');
            
            const goScreen = document.getElementById('gameOverScreen');
            goScreen.classList.remove('hidden');
            
            const btnContainer = document.getElementById('goButtons');
            btnContainer.innerHTML = '';

            if (!isMultiplayer) {
                document.getElementById('soloFinalScore').classList.remove('hidden');
                document.getElementById('multiplayerFinalBoard').classList.add('hidden');
                
                document.getElementById('soloFinalScore').innerHTML = `
                    <div style="text-align:center;">
                        <p>Your Score</p>
                        <p style="font-size:30px; color:#00ff9d; margin:0;">${Math.floor(score)}</p>
                    </div>
                `;
                
                btnContainer.innerHTML = `
                    <button onclick="restartGame()" style="background:#f39c12; color:#000; width:200px; margin-bottom:10px;">PLAY AGAIN üîÑ</button>
                    <button onclick="leaveLobby()" style="width:200px;">BACK TO MENU</button>
                    <button onclick="shareOnTwitter()" class="secondary-btn" style="width:200px;">Share Score</button>
                `;
            } else {
                document.getElementById('soloFinalScore').classList.add('hidden');
                document.getElementById('multiplayerFinalBoard').classList.remove('hidden');
                
                btnContainer.innerHTML = `
                    <button onclick="leaveLobby()" style="width:200px;">BACK TO MENU</button>
                    <button onclick="shareOnTwitter()" class="secondary-btn" style="width:200px;">Share Score</button>
                `;
                
                const roomRef = window.dbRef(window.db, `rooms/${roomId}`);
                window.dbGet(roomRef).then(snap => {
                   if(snap.exists() && snap.val().players) renderFinalLeaderboard(snap.val().players);
                });
            }
        }

        window.shareOnTwitter = function() {
            const text = encodeURIComponent(`I scored ${Math.floor(score)} in Stork Runner Multiplayer!`);
            window.open(`https://x.com/intent/tweet?text=${text}&hashtags=StorkRunner`, '_blank');
        }

        // --- Loop ---
        function loop(timestamp) {
            if (!isRunning) return;
            
            if (!lastTime) lastTime = timestamp;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            const timeFactor = deltaTime / targetDelta;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Ground
            ctx.fillStyle = "#2a2e3f"; ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
            ctx.beginPath(); ctx.moveTo(0, canvas.height - 60); ctx.lineTo(canvas.width, canvas.height - 60);
            ctx.strokeStyle = "#00ff9d"; ctx.lineWidth = 3; ctx.stroke();

            // Player Physics
            if (isInvincible) { invincibilityTimer -= timeFactor; if(invincibilityTimer <= 0) isInvincible = false; }
            player.dy += gravity * timeFactor;
            player.y += player.dy * timeFactor;
            if (player.y + player.height > canvas.height - 60) {
                player.y = canvas.height - 60 - player.height; player.dy = 0; player.grounded = true;
            } else { player.grounded = false; }

            // Draw Player
            ctx.save();
            const cx = player.x + player.width/2;
            const cy = player.y + player.height/2;
            ctx.translate(cx, cy);
            if (!player.facingRight) ctx.scale(-1, 1); 
            
            const blink = !isInvincible || (frames % 10 < 5);
            if(blink) {
                if(playerImage.complete && playerImage.naturalWidth) 
                    ctx.drawImage(playerImage, -player.width/2, -player.height/2, player.width, player.height);
                else { 
                    ctx.font="40px Arial"; ctx.fillText("ü¶¢", -10, 10); 
                }
            }
            ctx.restore();

            // Obstacles
            if (frames % 100 === 0 && Math.random() > 0.3) {
                obstacles.push({x:canvas.width, y:canvas.height-60-40, w:40, h:40, type:['‚è≥','üß±','‚õΩ'][Math.floor(Math.random()*3)]});
            }
            if (frames % 40 === 0 && Math.random() > 0.5) {
                let isMagnet = Math.random() > 0.9;
                let ty = isMagnet ? canvas.height-90 : (Math.random()>0.5 ? canvas.height-90 : canvas.height-160);
                tokens.push({x:canvas.width, y:ty, size:30, type: isMagnet ? 'üß≤' : '‚ö°'});
            }

            // Update Objects
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.x -= gameSpeed * timeFactor;
                ctx.font = "35px Arial"; ctx.fillText(obs.type, obs.x, obs.y+35);
                
                if(!isInvincible && player.x < obs.x+obs.w-15 && player.x+player.width > obs.x+15 && player.y < obs.y+obs.h-15 && player.y+player.height > obs.y+15) {
                    currentLives--; spawnParticles(player.x, player.y, 'red', 10); updateLifeDisplay();
                    
                    if(currentLives <= 0) {
                        gameOver();
                        return; 
                    }
                    else { isInvincible = true; invincibilityTimer = 120; playSound('hit'); }
                    obstacles.splice(i, 1);
                }
                if(obs.x + obs.w < 0) obstacles.splice(i, 1);
            }

            // --- MAGNET LOGIC ---
            for (let i = tokens.length - 1; i >= 0; i--) {
                let t = tokens[i];
                let isAttracted = false;

                if(isMagnetActive && t.type === '‚ö°') {
                   let dx = (player.x) - t.x; let dy = (player.y) - t.y;
                   let dist = Math.sqrt(dx*dx+dy*dy);
                   
                   if(dist < 300) { 
                       t.x += dx*0.1*timeFactor; 
                       t.y += dy*0.1*timeFactor; 
                       isAttracted = true;
                   }
                }
                
                if (!isAttracted) {
                    t.x -= gameSpeed * timeFactor;
                }

                ctx.font = "30px Arial"; ctx.fillText(t.type, t.x, t.y+30);
                
                if(player.x < t.x+t.size && player.x+player.width > t.x && player.y < t.y+t.size && player.y+player.height > t.y) {
                    if(t.type === '‚ö°') { score+=10; playSound('token'); }
                    else { isMagnetActive=true; magnetTimer=600; magnetTimerDisplay.classList.add('active'); playSound('magnet'); }
                    tokens.splice(i, 1);
                }
                else if(t.x + t.size < 0) tokens.splice(i, 1);
            }

            particles.forEach((p,i) => {
                p.x -= gameSpeed; p.x+=p.sx; p.y+=p.sy; p.life-=0.05;
                ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); ctx.globalAlpha=1;
                if(p.life<=0) particles.splice(i,1);
            });

            if(isMagnetActive) {
                magnetTimer -= timeFactor;
                magnetTimeRemainingEl.innerText = Math.ceil(magnetTimer/60);
                if(magnetTimer<=0) { isMagnetActive=false; magnetTimerDisplay.classList.remove('active'); }
            }

            score += 0.05 * timeFactor;
            scoreEl.innerText = Math.floor(score);
            frames++;
            if(frames % 500 === 0) { gameSpeed += 0.8; speedEl.innerText = (gameSpeed/5).toFixed(1)+"x"; }
            if(isMultiplayer && frames % 30 === 0) syncScore();

            if (isRunning) loopId = requestAnimationFrame(loop);
        }

        // Inputs
        window.addEventListener('keydown', e => { if(e.code==='Space'||e.code==='ArrowUp') jump(); });
        canvas.addEventListener('touchstart', e => { e.preventDefault(); jump(); }, {passive:false});
        canvas.addEventListener('mousedown', jump);

    </script>
</body>
</html>
